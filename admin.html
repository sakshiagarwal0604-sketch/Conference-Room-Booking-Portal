<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel | GovSynapse</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* small admin-specific styles - won't affect calendar/form pages */
    .admin-wrapper { max-width: 1050px; margin: 2rem auto; padding: 1rem; }
    .top-row { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .panel-title { font-size:1.6rem; color:#1a237e; }
    .controls { display:flex; gap:8px; align-items:center; }
    .admin-btn { background:#1a237e; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    .admin-btn.danger { background:#008b8b; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1rem; margin-top:1rem; }
    .card { background:#fff; padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .card h4 { margin-bottom:6px; }
    .muted { color:#666; font-size:0.95rem; }
    .empty-note { color:#666; padding:12px 0; }
    /* small responsive tweak */
    @media(max-width:600px){ .top-row { flex-direction:column; align-items:flex-start; } }
  </style>
</head>
<body>
  <nav>
    <div class="logo-section">
      <img src="https://img.icons8.com/external-flatart-icons-outline-flatarticons/64/1a237e/external-meeting-office-flatart-icons-outline-flatarticons.png" alt="logo">
      <span class="logo-text">GovSynapse</span>
    </div>

    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About Us</a></li>
      <li><a href="booking.html">Book a Room</a></li>
      <li><a href="rooms.html">Rooms</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="admin.html" class="active">Admin Panel</a></li>
    </ul>

    <span id="roleTag"></span>
    <button class="btn" onclick="logout()">Logout</button>
  </nav>

  <main class="admin-wrapper">
    <div class="top-row">
      <div>
        <div class="panel-title">Admin Dashboard</div>
        <div class="muted" id="adminSub"></div>
      </div>

      <div class="controls">
        <button class="admin-btn" id="refreshBtn">Refresh</button>
        <button class="admin-btn danger" id="clearBookingsBtn">Clear All Bookings</button>
        <button class="admin-btn danger" id="clearContactsBtn">Clear All Messages</button>
      </div>
    </div>

    <h3 style="margin-top:20px;">Meeting Rooms Booked</h3>
    <div id="bookingsContainer" class="grid"></div>

    <h3 style="margin-top:26px;">Feedback / Contact Messages</h3>
    <div id="contactsContainer" class="grid"></div>
  </main>

  <footer><p>© 2025 GovSynapse</p></footer>

  <script src="auth.js"></script>
  <script src="script.js"></script>

  <script>
    // Admin/Owner page logic
    (function adminPage() {
      const user = (getCurrentUser && getCurrentUser()) || null;
      if (!user) {
        // redirect to login
        window.location.href = "login.html";
        return;
      }
      // owner may use this page for full access; admins limited
      if (user.role !== "admin" && user.role !== "owner") {
        alert("Access denied. Admins/Owner only.");
        window.location.href = "login.html";
        return;
      }

      document.getElementById("roleTag").innerText = "Role: " + user.role.toUpperCase() + " (" + user.username + ")";
      const adminSub = document.getElementById("adminSub");
      adminSub.innerText = user.role === "owner" ? "Owner — Full access" : "Admin — Assigned bookings only";

      const bookingsContainer = document.getElementById("bookingsContainer");
      const contactsContainer = document.getElementById("contactsContainer");
      const refreshBtn = document.getElementById("refreshBtn");
      const clearBookingsBtn = document.getElementById("clearBookingsBtn");
      const clearContactsBtn = document.getElementById("clearContactsBtn");

      function render() {
        const allBookings = JSON.parse(localStorage.getItem("bookings")) || [];
        const allContacts = JSON.parse(localStorage.getItem("contacts")) || [];

        // bookings visible to current user
        let visibleBookings = [];
        if (user.role === "owner") visibleBookings = allBookings;
        else visibleBookings = allBookings.filter(b => b.assignedAdmin === user.username);

        bookingsContainer.innerHTML = "";
        if (visibleBookings.length === 0) {
          bookingsContainer.innerHTML = '<div class="empty-note">No bookings found for you.</div>';
        } else {
          visibleBookings.forEach(b => {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <h4>${b.room}</h4>
              <div class="muted">Meeting: ${b.description || "—"}</div>
              <p style="margin-top:8px;"><strong>${b.name}</strong> (${b.bookedBy})</p>
              <p>${b.date} • ${b.time} - ${b.endTime} • Duration: ${b.duration}h</p>
              <p>Phone: ${b.phone} • Email: ${b.email}</p>
              <div style="margin-top:8px;"><small class="muted">Assigned admin: ${b.assignedAdmin || '—'}</small></div>
            `;
            bookingsContainer.appendChild(card);
          });
        }

        // relevant contacts:
        // show all contacts if owner; if admin show contacts that either have relatedAdmin === admin or email matches admin bookings
        let visibleContacts = [];
        if (user.role === "owner") visibleContacts = allContacts;
        else {
          const myBookingEmails = new Set(visibleBookings.map(x => x.email));
          visibleContacts = allContacts.filter(c => (c.relatedAdmin && c.relatedAdmin === user.username) || myBookingEmails.has(c.email));
        }

        contactsContainer.innerHTML = "";
        if (visibleContacts.length === 0) {
          contactsContainer.innerHTML = '<div class="empty-note">No contact messages found.</div>';
        } else {
          visibleContacts.forEach(c => {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <h4>${c.subject || "Message"}</h4>
              <div class="muted">From: ${c.name} • ${c.email}</div>
              <p style="margin-top:8px">${c.message}</p>
              <div style="margin-top:8px;"><small class="muted">${new Date(c.createdAt || "").toLocaleString() || ""}</small></div>
            `;
            contactsContainer.appendChild(card);
          });
        }
      }

      refreshBtn.addEventListener("click", () => render());

      clearBookingsBtn.addEventListener("click", () => {
        if (user.role !== "owner") {
          // only owner allowed to clear ALL bookings (as per earlier requirement)
          if (!confirm("Only the owner can clear ALL bookings. Do you want to clear bookings assigned to you instead?")) return;
          // clear only bookings assigned to this admin
          const allBookings = JSON.parse(localStorage.getItem("bookings")) || [];
          const remaining = allBookings.filter(b => b.assignedAdmin !== user.username);
          localStorage.setItem("bookings", JSON.stringify(remaining));
          render();
          alert("Your bookings cleared.");
          return;
        }
        if (confirm("Are you sure you want to CLEAR ALL BOOKINGS? This cannot be undone.")) {
          localStorage.removeItem("bookings");
          render();
          alert("All bookings cleared.");
        }
      });

      clearContactsBtn.addEventListener("click", () => {
        if (user.role !== "owner") {
          if (!confirm("Only the owner can clear ALL messages. Do you want to clear messages related to you instead?")) return;
          const allContacts = JSON.parse(localStorage.getItem("contacts")) || [];
          const remaining = allContacts.filter(c => !(c.relatedAdmin === user.username));
          localStorage.setItem("contacts", JSON.stringify(remaining));
          render();
          alert("Your related messages cleared.");
          return;
        }
        if (confirm("Are you sure you want to CLEAR ALL CONTACT MESSAGES? This cannot be undone.")) {
          localStorage.removeItem("contacts");
          render();
          alert("All messages cleared.");
        }
      });

      // initial render
      render();
    })();
  </script>
</body>
</html>
